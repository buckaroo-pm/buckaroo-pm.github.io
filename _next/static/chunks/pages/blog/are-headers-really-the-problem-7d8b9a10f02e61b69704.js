_N_E=(window.webpackJsonp_N_E=window.webpackJsonp_N_E||[]).push([[13],{SfZy:function(e,a,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/blog/are-headers-really-the-problem",function(){return t("z1eh")}])},z1eh:function(e,a,t){"use strict";t.r(a),t.d(a,"frontMatter",(function(){return l})),t.d(a,"default",(function(){return u}));var n=t("rePB"),o=t("Ff2n"),c=(t("q1tI"),t("7ljp")),r=t("ZDfL");function s(e,a){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);a&&(n=n.filter((function(a){return Object.getOwnPropertyDescriptor(e,a).enumerable}))),t.push.apply(t,n)}return t}function p(e){for(var a=1;a<arguments.length;a++){var t=null!=arguments[a]?arguments[a]:{};a%2?s(Object(t),!0).forEach((function(a){Object(n.a)(e,a,t[a])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):s(Object(t)).forEach((function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(t,a))}))}return e}var l={title:"Are Headers Really the Problem?",created:"2019-02-26T11:00:00.000Z",author:"Team Buckaroo",summary:"A huge barrier that newcomers to C++ face is that of undefined references. We create a project, include a few headers and BOOM, linker error. What if we could fix this at a build-system level?",banner:"/posts/header-problem.jpeg",__resourcePath:"blog/are-headers-really-the-problem.md",__scans:{},layout:"index"},i={frontMatter:l},m=r.a;function u(e){var a=e.components,t=Object(o.a)(e,["components"]);return Object(c.a)(m,p(p(p({},i),t),{},{components:a,mdxType:"MDXLayout"}),Object(c.a)("p",null,"A huge barrier that newcomers to C++ face is that of undefined references. We create a project, include a few headers and ",Object(c.a)("strong",{parentName:"p"},"BOOM"),", linker error."),Object(c.a)("p",null,'In fact, searches for "undefined reference" do not trail that far behind searches for "clang".'),Object(c.a)("p",null,Object(c.a)("img",p({parentName:"p"},{src:"/img/undefined-ref-trends.png",alt:"Google Trends"}))),Object(c.a)("p",null,Object(c.a)("em",{parentName:"p"},'Google Trends, "clang" (red) vs "undefined reference" (blue)')),Object(c.a)("p",null,"Why is this?"),Object(c.a)("p",null,"Well, unlike most languages, C++ splits code into ",Object(c.a)("em",{parentName:"p"},"headers")," and ",Object(c.a)("em",{parentName:"p"},"implementations"),". Public headers define the interface for your code - the types, memory layout, available functions, etc. The implementations define how it works."),Object(c.a)("pre",p({},{className:"language-cpp"}),Object(c.a)("code",p({parentName:"pre"},{className:"language-cpp"}),Object(c.a)("span",p({parentName:"code"},{className:"token comment"}),"/* foo.h */"),"\n\n",Object(c.a)("span",p({parentName:"code"},{className:"token macro property"}),Object(c.a)("span",p({parentName:"span"},{className:"token directive-hash"}),"#"),Object(c.a)("span",p({parentName:"span"},{className:"token directive keyword"}),"ifndef")," ",Object(c.a)("span",p({parentName:"span"},{className:"token expression"}),"FOO_H")),"\n",Object(c.a)("span",p({parentName:"code"},{className:"token macro property"}),Object(c.a)("span",p({parentName:"span"},{className:"token directive-hash"}),"#"),Object(c.a)("span",p({parentName:"span"},{className:"token directive keyword"}),"define")," ",Object(c.a)("span",p({parentName:"span"},{className:"token macro-name"}),"FOO_H")),"\n\n",Object(c.a)("span",p({parentName:"code"},{className:"token keyword"}),"int")," ",Object(c.a)("span",p({parentName:"code"},{className:"token function"}),"foo"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),";"),"\n\n",Object(c.a)("span",p({parentName:"code"},{className:"token macro property"}),Object(c.a)("span",p({parentName:"span"},{className:"token directive-hash"}),"#"),Object(c.a)("span",p({parentName:"span"},{className:"token directive keyword"}),"endif")),"\n")),Object(c.a)("p",null,Object(c.a)("em",{parentName:"p"},"There is a function call foo, that returns an int")),Object(c.a)("pre",p({},{className:"language-cpp"}),Object(c.a)("code",p({parentName:"pre"},{className:"language-cpp"}),Object(c.a)("span",p({parentName:"code"},{className:"token comment"}),"/* foo.cpp */"),"\n\n",Object(c.a)("span",p({parentName:"code"},{className:"token keyword"}),"int")," ",Object(c.a)("span",p({parentName:"code"},{className:"token function"}),"foo"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")")," ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"{"),"\n  ",Object(c.a)("span",p({parentName:"code"},{className:"token keyword"}),"return")," ",Object(c.a)("span",p({parentName:"code"},{className:"token number"}),"1")," ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"+")," ",Object(c.a)("span",p({parentName:"code"},{className:"token number"}),"2"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),";"),"\n",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"}"),"\n")),Object(c.a)("p",null,Object(c.a)("em",{parentName:"p"},"foo returns 1 + 2")),Object(c.a)("p",null,Object(c.a)("em",{parentName:"p"},"Undefined references")," occur when you depend on a header, but not on the corresponding translation-unit(s)."),Object(c.a)("p",null,"Some have argued that this is a reason not to have headers at all. Indeed, Java avoids the use of headers because it makes things simpler:"),Object(c.a)("blockquote",null,Object(c.a)("p",{parentName:"blockquote"},"Source code written in Java is simple. There is no preprocessor, no #define and related capabilities, no typedef, and absent those features, no longer any need for header files. Instead of header files, Java language source files provide the definitions of other classes and their methods.")),Object(c.a)("p",null,Object(c.a)("a",p({parentName:"p"},{href:"http://java.sun.com/docs/white/langenv/"}),"Section 2.2.1 of the Java Language Environment white paper")),Object(c.a)("p",null,"But maybe this isn't a failure of the ",Object(c.a)("em",{parentName:"p"},"language"),", but a failure of our ",Object(c.a)("em",{parentName:"p"},"build-systems"),"."),Object(c.a)("p",null,"Using the compiler, a build-system can figure out the list of headers that your project uses. It's not difficult, either."),Object(c.a)("p",null,"Suppose we have a project like this:"),Object(c.a)("pre",p({},{className:"language-bash"}),Object(c.a)("code",p({parentName:"pre"},{className:"language-bash"}),"$ tree ",Object(c.a)("span",p({parentName:"code"},{className:"token builtin class-name"}),"."),"\n",Object(c.a)("span",p({parentName:"code"},{className:"token builtin class-name"}),"."),"\n\u251c\u2500\u2500 foo\n\u2502   \u251c\u2500\u2500 bar.cpp\n\u2502   \u251c\u2500\u2500 bar.h\n\u2502   \u251c\u2500\u2500 baz\n\u2502   \u2502   \u2514\u2500\u2500 baz.h\n\u2502   \u251c\u2500\u2500 foo.cpp\n\u2502   \u2514\u2500\u2500 foo.h\n\u251c\u2500\u2500 main.cpp\n\u2514\u2500\u2500 qux\n    \u251c\u2500\u2500 qux.cpp\n    \u2514\u2500\u2500 qux.h\n\n",Object(c.a)("span",p({parentName:"code"},{className:"token number"}),"3")," directories, ",Object(c.a)("span",p({parentName:"code"},{className:"token number"}),"7")," files\n")),Object(c.a)("p",null,"Then we can find the include-graph for ",Object(c.a)("inlineCode",{parentName:"p"},"main.cpp")," like this:"),Object(c.a)("pre",p({},{className:"language-bash"}),Object(c.a)("code",p({parentName:"pre"},{className:"language-bash"}),"$ gcc -I ",Object(c.a)("span",p({parentName:"code"},{className:"token builtin class-name"}),".")," -MM ./main.cpp\nmain.o: main.cpp foo/foo.h foo/bar.h foo/baz/baz.h qux/qux.h\n")),Object(c.a)("p",null,"So we can figure out the set of headers that a given translation-unit depends on. Now, we need to ensure that if we depend on any header, we also link to the library target that it belongs to."),Object(c.a)("p",null,"In this case, we depend on ",Object(c.a)("inlineCode",{parentName:"p"},"foo/foo.h"),", which is implemented by ",Object(c.a)("inlineCode",{parentName:"p"},"foo/foo.cpp")," in the target ",Object(c.a)("inlineCode",{parentName:"p"},"foo"),", and ",Object(c.a)("inlineCode",{parentName:"p"},"qux/qux.h"),", which is implemented by ",Object(c.a)("inlineCode",{parentName:"p"},"qux/qux.cpp")," in target ",Object(c.a)("inlineCode",{parentName:"p"},"qux"),"."),Object(c.a)("table",null,Object(c.a)("thead",{parentName:"table"},Object(c.a)("tr",{parentName:"thead"},Object(c.a)("th",p({parentName:"tr"},{align:null}),"Library Target"),Object(c.a)("th",p({parentName:"tr"},{align:null}),"Header(s)"),Object(c.a)("th",p({parentName:"tr"},{align:null}),"Translation-unit(s)"))),Object(c.a)("tbody",{parentName:"table"},Object(c.a)("tr",{parentName:"tbody"},Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"foo")),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"foo/bar.h")),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"foo/bar.cpp"))),Object(c.a)("tr",{parentName:"tbody"},Object(c.a)("td",p({parentName:"tr"},{align:null})),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"foo/baz/baz.h")),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"foo/foo.cpp"))),Object(c.a)("tr",{parentName:"tbody"},Object(c.a)("td",p({parentName:"tr"},{align:null})),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"foo/foo.h")),Object(c.a)("td",p({parentName:"tr"},{align:null}))),Object(c.a)("tr",{parentName:"tbody"},Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"qux")),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"qux/qux.h")),Object(c.a)("td",p({parentName:"tr"},{align:null}),Object(c.a)("inlineCode",{parentName:"td"},"qux/qux.cpp"))))),Object(c.a)("p",null,"So we need to introduce a rule:"),Object(c.a)("blockquote",null,Object(c.a)("p",{parentName:"blockquote"},"If you include header X then you must also link to the library target that X belongs to")),Object(c.a)("p",null,"With this rule in place, we cannot just forget to link ",Object(c.a)("inlineCode",{parentName:"p"},"bar.o"),", ",Object(c.a)("inlineCode",{parentName:"p"},"qux.o")," or ",Object(c.a)("inlineCode",{parentName:"p"},"foo.o"),". If we try, then the build-system will detect this, and tell us where we went wrong."),Object(c.a)("p",null,"To support this, targets in the build-system must declare every header-file that belongs to it. Otherwise, we have no way of knowing where a header should come from."),Object(c.a)("p",null,"This is quite practical, if you use globs:"),Object(c.a)("pre",p({},{className:"language-python"}),Object(c.a)("code",p({parentName:"pre"},{className:"language-python"}),"cxx_library",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),"\n  name ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"=")," ",Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'foo'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  exportd_headers ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"=")," subdir_glob",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"["),"\n    ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'foo'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),",")," ",Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'**/*.h'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"]"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  srcs ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"=")," glob",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"["),"\n    ",Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'foo/**/*.cpp'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"]"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),"\n\ncxx_library",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),"\n  name ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"=")," ",Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'qux'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  exportd_headers ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"=")," subdir_glob",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"["),"\n    ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'qux'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),",")," ",Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'**/*.h'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"]"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  srcs ",Object(c.a)("span",p({parentName:"code"},{className:"token operator"}),"=")," glob",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"("),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"["),"\n    ",Object(c.a)("span",p({parentName:"code"},{className:"token string"}),"'qux/**/*.cpp'"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n  ",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),"]"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),","),"\n",Object(c.a)("span",p({parentName:"code"},{className:"token punctuation"}),")"),"\n")),Object(c.a)("p",null,"In summary:"),Object(c.a)("ul",null,Object(c.a)("li",{parentName:"ul"},"Headers are not necessarily evil."),Object(c.a)("li",{parentName:"ul"},"We can query the compiler for actual header-usage."),Object(c.a)("li",{parentName:"ul"},"Build targets should declare the header-files (not directories) they export."),Object(c.a)("li",{parentName:"ul"},"The build-system should enforce that if you include a header-file, you must link to its corresponding library target.")),Object(c.a)("hr",null),Object(c.a)("h2",null,"Notes"),Object(c.a)("ol",null,Object(c.a)("li",{parentName:"ol"},"Interestingly, CMake, the most popular C++ build-system, does not get this right. Where it could offer guarantees, it only offers conventions."),Object(c.a)("li",{parentName:"ol"},"Another benefit is that if two targets export headers to the same include-path, we can detect and resolve this conflict. Otherwise the behavior is determined by the order of compiler flags, which is usually coincidental."),Object(c.a)("li",{parentName:"ol"},"Sometimes there is more than one translation-unit for a given header. In this case, we need to ensure that all translation-units for the header are linked."),Object(c.a)("li",{parentName:"ol"},"I made some updates to clear up the distinction between library targets and translation-units.")))}u.isMDXComponent=!0}},[["SfZy",0,2,1,3,4]]]);