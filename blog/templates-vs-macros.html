<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"/><link rel="stylesheet" type="text/css" href="/prism.css"/><meta name="next-head-count" content="4"/><link rel="preload" href="/_next/static/css/a0584ae5515792e72ab5.css" as="style"/><link rel="stylesheet" href="/_next/static/css/a0584ae5515792e72ab5.css" data-n-g=""/><noscript data-n-css=""></noscript><link rel="preload" href="/_next/static/chunks/main-7d1613afc8c8f43cb50f.js" as="script"/><link rel="preload" href="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" as="script"/><link rel="preload" href="/_next/static/chunks/framework.ae3781fe50e43492a499.js" as="script"/><link rel="preload" href="/_next/static/chunks/commons.9b549cceddc4472f1953.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/_app-3e4ffec4bbf3a45ef50f.js" as="script"/><link rel="preload" href="/_next/static/chunks/c18d713dde5d8f274a9340ae8a63196292880c5e.7af0c42e7b17c91d2be5.js" as="script"/><link rel="preload" href="/_next/static/chunks/fe8ef1070ee43d1bcce443c3875737aef33fa79f.55d4b28eaf40fcb59af0.js" as="script"/><link rel="preload" href="/_next/static/chunks/pages/blog/templates-vs-macros-b9f3d1cfde405b110798.js" as="script"/></head><body><div id="__next"><div class="site"><div class="site"><div class="navigation"><div class="view row space-between"><div class="links"><a class="buckaroo" href="/">Buckaroo</a><a href="https://github.com/LoopPerfect/buckaroo/wiki" target="_blank">Docs</a><a href="/blog">Blog</a></div><div class="search"><input placeholder="search for a module..." value=""/><button class="fa fa-search fa-large"></button></div><iframe id="star-button" src="https://ghbtns.com/github-btn.html?user=LoopPerfect&amp;repo=buckaroo&amp;type=star&amp;count=true&amp;size=large" frameBorder="0" scrolling="0" width="160px" height="30px"></iframe></div></div><div></div><div style="width:100%;max-height:80vh;overflow:hidden"><img src="/posts/templates-vs-macros.jpeg" style="width:100%"/></div><div class="banner white"><div class="view"><div><h1>Comparing the Compilation Times of C++ Templates and Macros</h1><div class="post"><h2>TL;DR</h2><p>For our example, templates compile faster than generated code. With a few tricks, they are also faster for incremental builds.</p><h2>Introduction</h2><p>Templates are a polarizing feature of C++. On the one hand, people love the ability to squeeze out extra performance and add syntactic sugar to their projects. On the other, some argue that they are slow to compile, bloat binaries and give incomprehensible error messages.</p><p>This article will look at one common use-cases of templates and determine if compile times are improved by using code-generation rather than templates.</p><h2>Simple Vector Class</h2><p>We’re going to look at a simple vector class with a size determined at compile-time. The usage of this class might look like this:</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// Create a vector of 10 elements, all initialized to 0</span>
<span class="token keyword">auto</span> v <span class="token operator">=</span> Vector<span class="token operator">&lt;</span><span class="token number">10</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Set the 1st element to 7</span>
v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">7</span><span class="token punctuation">;</span>

<span class="token comment">// Set the 9th element to 3</span>
v<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">// Print the sum of all elements</span>
std<span class="token operator">::</span>cout <span class="token operator">&lt;&lt;</span> v<span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> std<span class="token operator">::</span>endl<span class="token punctuation">;</span>

<span class="token comment">// Error!</span>
v<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
</code></pre><p>The implementation is quite simple: we have a regular C++ struct with one type parameter for the length of the vector:</p><pre class="language-cpp"><code class="language-cpp"><span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">int</span> D<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Vector</span> <span class="token punctuation">{</span>
  <span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">unsigned</span> N <span class="token operator">=</span> D<span class="token punctuation">;</span>
  <span class="token keyword">int</span> data<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span>
  
  <span class="token function">Vector</span><span class="token punctuation">(</span>Vector<span class="token operator">&lt;</span>D<span class="token operator">&gt;</span> <span class="token keyword">const</span><span class="token operator">&amp;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token function">Vector</span><span class="token punctuation">(</span><span class="token keyword">int</span> fill <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> fill<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> N<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">+=</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> result<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">int</span><span class="token operator">*</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token function">begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">*</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token operator">&amp;</span>data<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>

  <span class="token keyword">int</span><span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">const</span><span class="token operator">&amp;</span> i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">&lt;=</span> i<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">&quot;out of bound&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">int</span> <span class="token keyword">const</span><span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">const</span><span class="token operator">&amp;</span> i<span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>N <span class="token operator">&lt;=</span> i<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token string">&quot;out of bound&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><p>However, we could also implement this class using the preprocessor!</p><pre class="language-cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CREATE_VECTOR</span><span class="token expression"><span class="token punctuation">(</span>D<span class="token punctuation">)</span> </span><span class="token punctuation">\</span>
<span class="token expression"><span class="token keyword">struct</span> <span class="token class-name">Vector_</span></span><span class="token punctuation">##</span><span class="token expression">D <span class="token punctuation">{</span></span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">static</span> <span class="token keyword">constexpr</span> <span class="token keyword">int</span> N <span class="token operator">=</span> D<span class="token punctuation">;</span></span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token keyword">int</span> data<span class="token punctuation">[</span>N<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
<span class="token punctuation">\</span>
  <span class="token expression">Vector_</span><span class="token punctuation">##</span><span class="token expression"><span class="token function">D</span> <span class="token punctuation">(</span>Vector_</span><span class="token punctuation">##</span><span class="token expression">D <span class="token keyword">const</span><span class="token operator">&amp;</span> v<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">&lt;</span>N <span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span></span><span class="token punctuation">\</span>
      <span class="token expression">data<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> v<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span></span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span></span><span class="token punctuation">\</span>
  <span class="token expression"><span class="token punctuation">}</span></span><span class="token punctuation">\</span>
<span class="token punctuation">\</span>
</span>
<span class="token comment">// etc...</span>
</code></pre><p>These two implementations give us equivalent functionality. However, for a given size N, the first generates a vector class using templates and the second using macros.</p><p><strong>The question is: which compiles faster?</strong></p><p>To compare the two approaches, we wrote a small code snippet that uses vector classes from length 0 to 256. We also tested another approach, where we took the macro implementation but ran the preprocessor <em>before</em> the test. This is equivalent to writing every class by hand!</p><p>We compiled each version 100 times and measured how long it took. Here are the results:</p><table><thead><tr><th>CXX</th><th>Macros</th><th>Preprocessed Macros</th><th>Templates</th></tr></thead><tbody><tr><td>clang 4.0</td><td>40s</td><td>37s</td><td>30s</td></tr><tr><td>g++ 6.2</td><td>61s</td><td>66s</td><td>48s</td></tr></tbody></table><h3>Conclusion</h3><p>The results show that for this example, <em>compiling templates is faster than the equivalent macro version</em>! On top of that, templates are more maintainable, since the code is not duplicated, and the compiler can give better error messages.</p><p>If you consider how templates work, then this makes a great deal of sense. Instantiating a template is just a replacement of its template-parameters with concrete values or types. With code generation, we must parse the C++ and build the AST from scratch for each macro-result.</p><p><strong>But What About Incremental Builds?</strong></p><p>This test leaves out incremental builds. One advantage of using code-generation (it is claimed!) is that implementation of each vector class can be put inside of its own translation-unit, meaning that it does not have to be recompiled every time that it is used.</p><p>However, we can achieve the same effect using templates! C++ 11 introduced the extern template construct, which tells the compiler that a template is compiled in another translation-unit:</p><pre class="language-cpp"><code class="language-cpp">
<span class="token comment">// Vector&lt;16&gt; is in another binary</span>
<span class="token keyword">extern</span> <span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre><p><code>extern template</code> is like a forward declaration for templates.</p><p>We can use this construct to pull the most common template instantiations into their own translation-unit, dramatically decreasing incremental build times.</p><pre class="language-cpp"><code class="language-cpp">
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;vector.hpp&gt;</span></span>

<span class="token comment">// Instantiation of common sizes</span>
<span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">64</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre><p>And we extern template the common cases in the vector header to prevent consumers from compiling their own version.</p><pre class="language-cpp"><code class="language-cpp"><span class="token comment">// ...</span>
<span class="token comment">// Vector class above</span>

<span class="token comment">// Forward declaration of common sizes</span>
<span class="token keyword">extern</span> <span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">16</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">32</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">64</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token keyword">extern</span> <span class="token keyword">template</span> <span class="token keyword">class</span> <span class="token class-name">Vector</span><span class="token operator">&lt;</span><span class="token number">128</span><span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre><p>We then ran an incremental build (vector.cpp already compiled). The results speak for themselves:</p><table><thead><tr><th>CXX</th><th>Templates</th><th>Templates with Forward Decls</th></tr></thead><tbody><tr><td>clang 4.0</td><td>30s</td><td>12s compile + 16s link</td></tr><tr><td>g++ 6.2</td><td>48s</td><td>14s compile + 12s link</td></tr></tbody></table><p>Next time you are trying to improve your incremental build times, consider forward declaring your templates!</p><p><img src="https://cdn-images-1.medium.com/max/2272/1*0hqOaABQ7XGPT-OYNgiUBg.png"/></p><p><img src="https://cdn-images-1.medium.com/max/2272/1*Vgw1jkA6hgnvwzTsfMlnpg.png"/></p><p><img src="https://cdn-images-1.medium.com/max/2272/1*gKBpq1ruUi0FVK2UM_I4tQ.png"/></p><blockquote><p><a href="http://bit.ly/Hackernoon">Hacker Noon</a> is how hackers start their afternoons. We’re a part of the <a href="http://bit.ly/atAMIatAMI">@AMI</a> family. We are now <a href="http://bit.ly/hackernoonsubmission">accepting submissions</a> and happy to <a href="mailto:partners@amipublications.com">discuss advertising &amp; sponsorship</a> opportunities.
If you enjoyed this story, we recommend reading our <a href="http://bit.ly/hackernoonlatestt">latest tech stories</a> and <a href="https://hackernoon.com/trending">trending tech stories</a>. Until next time, don’t take the realities of the world for granted!</p></blockquote><p><img src="https://cdn-images-1.medium.com/max/30000/1*35tCjoPcvq6LbB3I6Wegqw.jpeg"/></p></div></div></div></div><div class="banner footer"><div class="view column"><div class="actions"><div class="links"><a href="/">Buckaroo</a><a href="https://github.com/LoopPerfect/buckaroo/wiki" target="_blank">Docs</a><a href="https://github.com/LoopPerfect/buckaroo" target="_blank">GitHub</a></div><div class="signup"><h1 class="action">Sign up for our Newsletter</h1><div class="info">Get the latest updates about new packages and Buckaroo releases.</div><button>Sign Up</button></div></div><div class="powered"><img src="/LoopPerfectInvertSmall.png"/><span>Powered by LoopPerfect</span></div></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/blog/templates-vs-macros","query":{},"buildId":"XEnVUsOG7VkTdg59Wro6f","nextExport":true,"autoExport":true,"isFallback":false}</script><script nomodule="" src="/_next/static/chunks/polyfills-617a3a2c770be2525c7f.js"></script><script src="/_next/static/chunks/main-7d1613afc8c8f43cb50f.js" async=""></script><script src="/_next/static/chunks/webpack-95c2b224bccf352ee870.js" async=""></script><script src="/_next/static/chunks/framework.ae3781fe50e43492a499.js" async=""></script><script src="/_next/static/chunks/commons.9b549cceddc4472f1953.js" async=""></script><script src="/_next/static/chunks/pages/_app-3e4ffec4bbf3a45ef50f.js" async=""></script><script src="/_next/static/chunks/c18d713dde5d8f274a9340ae8a63196292880c5e.7af0c42e7b17c91d2be5.js" async=""></script><script src="/_next/static/chunks/fe8ef1070ee43d1bcce443c3875737aef33fa79f.55d4b28eaf40fcb59af0.js" async=""></script><script src="/_next/static/chunks/pages/blog/templates-vs-macros-b9f3d1cfde405b110798.js" async=""></script><script src="/_next/static/XEnVUsOG7VkTdg59Wro6f/_buildManifest.js" async=""></script><script src="/_next/static/XEnVUsOG7VkTdg59Wro6f/_ssgManifest.js" async=""></script></body></html>